import "dotenv/config";
import {
  Client,
  GatewayIntentBits,
  Partials,
  EmbedBuilder,
  Events,
} from "discord.js";

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildMessages,
  ],
  partials: [Partials.GuildMember, Partials.User],
});

/* ---------- ‡∏õ‡∏π‡πÇ‡∏Å‡∏∞‡∏û‡∏π‡∏î‡πÄ‡∏≠‡∏á ---------- */
const MASCOT_NAME = "‡∏õ‡∏π‡πÇ‡∏Å‡∏∞";
const EMO = { crab: "ü¶Ä" };

/* ---------- Utils ---------- */
const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
const hour = () => new Date().getHours();

function timeGreeting() {
  const h = hour();
  if (h < 11) return "‡πÄ‡∏ä‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏•‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ‡πÄ‡∏•‡∏¢ ‡∏Å‡∏µ‡πä‡∏ö‡πÜ~ ‡πÇ‡∏Å‡∏∞‡∏ä‡∏á‡πÇ‡∏Å‡πÇ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡πà‡∏á‡∏à‡∏¥‡∏ö‡πÑ‡∏î‡πâ‡∏ô‡∏∞";
  if (h < 16) return "‡∏ö‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏î‡∏î‡∏≠‡∏∏‡πà‡∏ô ‡πÜ ‡πÇ‡∏Å‡∏∞‡∏õ‡∏π‡πÄ‡∏™‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏°‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô~";
  if (h < 19) return "‡πÄ‡∏¢‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏ô‡∏∏‡πà‡∏°‡∏´‡∏π‡∏°‡∏≤‡∏Å ‡πÇ‡∏Å‡∏∞‡∏û‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏õ‡πä‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏´‡∏°";
  return "‡∏î‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÇ‡∏Å‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏á‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≤ ‡∏°‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Å‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
}

/* ---------- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏´‡∏°‡∏ß‡∏î‡πÇ‡∏ó‡∏ô (‡∏õ‡∏π‡πÇ‡∏Å‡∏∞‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏≠‡∏á) ---------- */
const welcomeCategories = {
  warm: [
    (u) =>
      `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏î‡∏µ‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ **<@${u}>** ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏ñ‡∏≠‡∏∞ ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á`,
    (u) =>
      `${EMO.crab} ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ô‡∏∞ **<@${u}>** ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏á‡∏ó‡∏≤‡∏á‡∏ö‡∏≠‡∏Å‡πÇ‡∏Å‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÇ‡∏Å‡∏∞‡∏Ñ‡∏µ‡∏ö‡∏û‡∏≤‡πÑ‡∏õ`,
    (u) => `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡πÇ‡∏ö‡∏Å‡∏Å‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ **<@${u}>** ‡πÅ‡∏ö‡∏ö‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏™‡∏∏‡∏î ‡πÜ ‡πÄ‡∏•‡∏¢`,
  ],
  fun: [
    (u) =>
      `${EMO.crab} ‡∏Å‡∏µ‡πä‡∏ö‡πÜ! ‡πÇ‡∏Å‡∏∞‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö **<@${u}>** ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏¢~`,
    (u) => `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏Å ‡πÄ‡∏¢‡πâ ‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ **<@${u}>**`,
    (u) => `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏ã‡πâ‡∏≠‡∏°‡πÇ‡∏ö‡∏Å‡∏Å‡πâ‡∏≤‡∏°‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏Å **<@${u}>** ‡∏ô‡∏µ‡πà‡πÅ‡∏´‡∏•‡∏∞!`,
  ],
  goofy: [
    (u) =>
      `${EMO.crab} ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ß‡∏Å‡πâ‡∏≤‡∏°‡πÇ‡∏Å‡∏∞‡∏ô‡πâ‡∏≤ ‡πÇ‡∏Å‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‚Ä¶‡∏Ñ‡∏µ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÉ‡∏´‡πâ **<@${u}>** üòÜ`,
    (u) =>
      `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡∏Ñ‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤ ‚Äú‡∏Ç‡∏≠‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö **<@${u}>** ‡∏Ñ‡πà‡∏≤!‚Äù`,
    (u) =>
      `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏õ‡∏π‡∏û‡∏£‡∏°‡∏ó‡∏£‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏û‡∏≠‡∏î‡∏µ ‡πÄ‡∏ä‡∏¥‡∏ç **<@${u}>** ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤`,
  ],
  chill: [
    (u) =>
      `${EMO.crab} ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ä‡∏¥‡∏•‡∏°‡∏≤‡∏Å ‡πÇ‡∏Å‡∏∞‡∏ô‡∏±‡πà‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏™‡∏¥ **<@${u}>**`,
    (u) => `${EMO.crab} ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏£‡∏≠‡∏ö ‡πÜ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÇ‡∏Å‡∏∞‡∏û‡∏≤‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏ô‡∏∞ **<@${u}>**`,
    (u) =>
      `${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ü‡∏±‡∏á‡πÄ‡∏Å‡πà‡∏á‡∏ô‡∏∞ ‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏Å‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ **<@${u}>**`,
  ],
};

/** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡πÇ‡∏ó‡∏ô‚Äù ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ */
function chooseCategoryByTime() {
  const h = hour();
  const weights =
    h < 11
      ? { warm: 4, chill: 3, fun: 2, goofy: 1 }
      : h < 16
      ? { warm: 2, chill: 2, fun: 4, goofy: 3 }
      : h < 20
      ? { warm: 3, chill: 3, fun: 3, goofy: 2 }
      : { warm: 4, chill: 4, fun: 1, goofy: 2 };

  const bag = [];
  Object.keys(weights).forEach((k) => {
    for (let i = 0; i < weights[k]; i++) bag.push(k);
  });
  return pick(bag);
}

function randomWelcome(uid) {
  const cat = chooseCategoryByTime();
  const line = pick(welcomeCategories[cat]);
  return line(uid);
}

/* ---------- Client Ready ---------- */
client.once(Events.ClientReady, (c) => {
  console.log(`ü¶Ä ${MASCOT_NAME} online as ${c.user.tag}`);
});

/* ---------- Welcome Flow ---------- */
client.on(Events.GuildMemberAdd, async (member) => {
  try {
    const channelId = process.env.WELCOME_CHANNEL_ID;
    const rulesId = process.env.RULES_CHANNEL_ID;

    // ‡∏´‡∏≤‡πÅ‡∏ä‡∏ô‡πÅ‡∏ô‡∏•‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö: ‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏ß‡∏¢ env > systemChannel
    const fallback = member.guild.systemChannel ?? null;
    const channel =
      (channelId &&
        (member.guild.channels.cache.get(channelId) ||
          (await member.guild.channels.fetch(channelId).catch(() => null)))) ||
      fallback;

    if (!channel?.isTextBased()) return;

    const avatarSmall = member.user.displayAvatarURL({
      size: 256,
      dynamic: true,
    });
    const avatarLarge = member.user.displayAvatarURL({
      size: 512,
      dynamic: true,
    });

    const line = randomWelcome(member.id);
    const desc = [
      timeGreeting(),
      "",
      `**${line}**`,
      rulesId
        ? `‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÇ‡∏Å‡∏∞‡∏ä‡∏ß‡∏ô‡πÅ‡∏ß‡∏∞‡∏î‡∏π <#${rulesId}> ‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à`
        : null,
      "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ó‡πá‡∏Å‡∏´‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå /help ‡∏Å‡πá‡πÑ‡∏î‡πâ",
    ]
      .filter(Boolean)
      .join("\n");

    const embed = new EmbedBuilder()
      .setTitle(`ü¶Ä ‡πÇ‡∏Å‡∏∞‡∏°‡∏≤‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß`)
      .setDescription(desc)
      .setThumbnail(avatarSmall)
      .setImage(avatarLarge)
      .setFooter({
        text: `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏°‡∏µ ${member.guild.memberCount} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡∏à‡∏≤‡∏Å‡πÇ‡∏Å‡∏∞ ${EMO.crab}`,
      })
      .setColor(0x00bcd4)
      .setTimestamp();

    await channel.send({
      content: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${member} ${EMO.crab} ‡πÇ‡∏Å‡∏∞‡∏ù‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤`,
      embeds: [embed],
    });

    // DM ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÇ‡∏Å‡∏∞‡∏û‡∏π‡∏î‡πÄ‡∏≠‡∏á
    await member
      .send(
        [
          `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ô‡∏∞ **${member.user.username}** ‡πÇ‡∏Å‡∏∞‡πÄ‡∏≠‡∏á ${EMO.crab}`,
          `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà **${member.guild.name}** ‡πÄ‡∏•‡∏¢~`,
          rulesId
            ? `‡πÅ‡∏ß‡∏∞‡∏î‡∏π <#${rulesId}> ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠ ‡∏Å‡∏µ‡πä‡∏ö‡πÜ!`
            : `‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ ‡πÇ‡∏Å‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏µ‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡∏µ‡πä‡∏ö‡πÜ!`,
        ].join("\n")
      )
      .catch(() => {});
  } catch (err) {
    console.error("Error in GuildMemberAdd:", err);
  }
});

client.login(process.env.DISCORD_TOKEN);
